# 任务6：永久邮箱设置API接口 - 实施记录

## 任务概述
为学生角色实现永久邮箱设置功能的API接口，允许学生用户将一个临时邮箱设置为永久邮箱。

## 实施内容

### 1. 主设置接口 (app/api/emails/set-permanent/route.ts)

#### 1.1 POST - 设置永久邮箱
**功能特性：**
- ✅ 严格的权限验证（学生角色 + SET_PERMANENT_EMAIL 权限）
- ✅ 永久邮箱唯一性约束（每个学生只能设置一个）
- ✅ 邮箱所有权验证（只能设置自己的邮箱）
- ✅ 邮箱状态验证（不能设置已过期或已是永久的邮箱）
- ✅ 事务处理确保数据一致性

**请求参数：**
```json
{
  "emailId": "email-uuid-123"
}
```

**业务规则验证：**
- ✅ 用户必须是学生角色
- ✅ 用户不能已有永久邮箱
- ✅ 目标邮箱必须属于当前用户
- ✅ 目标邮箱不能已经是永久邮箱
- ✅ 目标邮箱不能已过期

**数据库更新：**
- ✅ 设置 `isPermanent = true`
- ✅ 更新 `expiresAt` 为永久时间（9999-01-01）

#### 1.2 GET - 获取永久邮箱信息
**功能特性：**
- ✅ 返回用户是否已设置永久邮箱
- ✅ 如已设置，返回永久邮箱详细信息
- ✅ 权限验证确保只有学生可访问

**响应格式：**
```json
{
  "hasPermanentEmail": true,
  "permanentEmail": {
    "id": "email-uuid",
    "address": "student@domain.com",
    "createdAt": 1640995200000,
    "expiresAt": 253402300800000
  }
}
```

### 2. 辅助查询接口 (app/api/emails/available-for-permanent/route.ts)

#### 2.1 GET - 获取可设置为永久邮箱的邮箱列表
**功能特性：**
- ✅ 检查用户是否已有永久邮箱
- ✅ 返回可用于设置永久邮箱的邮箱列表
- ✅ 过滤条件：未过期 + 非永久 + 属于当前用户

**响应格式：**
```json
{
  "canSetPermanent": true,
  "message": "您可以选择一个邮箱设置为永久邮箱",
  "permanentEmail": null,
  "availableEmails": [
    {
      "id": "email-uuid-1",
      "address": "temp1@domain.com",
      "createdAt": 1640995200000,
      "expiresAt": 1641081600000
    }
  ]
}
```

### 3. 权限控制系统

#### 3.1 双重权限验证
- ✅ **权限检查**：使用 `checkPermission(PERMISSIONS.SET_PERMANENT_EMAIL)`
- ✅ **角色检查**：额外验证用户角色为 `ROLES.STUDENT`
- ✅ **用户身份**：通过 `getUserId()` 获取当前用户ID

#### 3.2 权限错误处理
- ✅ 401: 未授权（未登录）
- ✅ 403: 权限不足（非学生角色）

### 4. 业务规则引擎

#### 4.1 唯一性约束
- ✅ 每个学生只能设置一个永久邮箱
- ✅ 数据库层面通过查询验证
- ✅ 事务处理确保并发安全

#### 4.2 邮箱状态验证
- ✅ 只能设置有效的临时邮箱
- ✅ 不能设置已过期的邮箱
- ✅ 不能重复设置已是永久的邮箱

#### 4.3 所有权验证
- ✅ 严格验证邮箱属于当前用户
- ✅ 防止用户设置他人的邮箱

### 5. 数据库操作

#### 5.1 事务处理
- ✅ 使用数据库事务确保操作原子性
- ✅ 所有验证和更新在同一事务中
- ✅ 失败时自动回滚

#### 5.2 数据更新
- ✅ 更新 `isPermanent` 字段为 true
- ✅ 设置 `expiresAt` 为永久时间
- ✅ 保持其他字段不变

### 6. API响应设计

#### 6.1 成功响应
```json
{
  "success": true,
  "message": "永久邮箱设置成功",
  "email": {
    "id": "email-uuid",
    "address": "student@domain.com",
    "isPermanent": true,
    "createdAt": 1640995200000,
    "expiresAt": 253402300800000
  }
}
```

#### 6.2 错误响应
- ✅ 400: 业务规则违反（已有永久邮箱、邮箱已过期等）
- ✅ 401: 未授权
- ✅ 403: 权限不足
- ✅ 404: 邮箱不存在
- ✅ 500: 服务器内部错误

### 7. 安全性保障

#### 7.1 参数验证
- ✅ 使用 Zod 进行严格的参数验证
- ✅ UUID 格式验证
- ✅ 必填字段检查

#### 7.2 权限安全
- ✅ 多层权限验证
- ✅ 用户身份确认
- ✅ 资源所有权验证

#### 7.3 数据安全
- ✅ 事务处理防止数据不一致
- ✅ 输入验证防止注入攻击
- ✅ 错误信息安全处理

### 8. 用户体验设计

#### 8.1 友好的错误信息
- ✅ 清晰的业务规则说明
- ✅ 具体的操作指导
- ✅ 中文错误信息

#### 8.2 状态查询支持
- ✅ 提供永久邮箱状态查询
- ✅ 提供可用邮箱列表查询
- ✅ 支持前端界面状态显示

## 验证结果
- ✅ TypeScript 编译无错误
- ✅ 权限验证正确，只有学生可访问
- ✅ 永久邮箱唯一性约束有效
- ✅ 邮箱所有权验证正确
- ✅ 数据库更新操作成功
- ✅ 响应格式符合规范
- ✅ 边界条件处理完善
- ✅ 业务规则验证完整

## 下一步
永久邮箱设置API接口已完成，可以进行任务7：前端登录表单扩展。
